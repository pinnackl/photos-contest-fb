<dom-module id="photo-list">
	<template>
		<style>
			:host {
				display: block;
			}

			:host paper-card {
			}

			paper-dialog.size-position {
				position: fixed;
				top: 16px;
				right: 16px;
				width: 90%;
				overflow: auto;
				box-sizing: content-box;
			}

			paper-dialog .scroll-section {
				background-color: #F1F1F1;
			}

			.photos {
				width: 240px;
				height: 168px;
				background-color: white;
		        border-top-left-radius: 2px;
		        border-top-right-radius: 2px;
			}
		</style>
		<!-- <iron-localstorage id="ls" name="app-storage" value="{{storage}}"></iron-localstorage> -->
		<paper-button raised on-tap="browsePhoto">Browse Photos</paper-button>
		<paper-dialog id="dialog" class="size-position">
			<div class="layout horizontal">
				<h2>Header</h2>
				<div class="flex"></div>
				<fb-upload-photo id="fbUploadPhoto"></fb-upload-photo>
			</div>
			<paper-dialog-scrollable class="scroll-section">
				<template is="dom-repeat" items={{photos}} as=photo index-as=index>
				<photo-card
					photo="[[photo.image]]"
					photo-source="[[photo.source]]"
					index="[[index]]"
					data="{{photoData}}">
				</photo-card>
				</template>
			</paper-dialog-scrollable>
			<div class="buttons">
				<paper-button dialog-dismiss>Cancel</paper-button>
				<paper-button dialog-confirm on-tap="_handleSelectImage">Accept</paper-button>
			</div>
		</paper-dialog>
	</template>
	<script>
		Polymer({
			is: 'photo-list',
			properties: {
				apiLoaded: {
					observer: '_apiLoaded'
				},
				photos: {
					type: Array,
					value: [],
					notify: true
				},
				photoSource: {
					type: Array,
					value: [],
					notify: true
				},
				storage: {
					type: Object
				},
				photoData: {
					notify: true,
					observer: '_photoDataChanged'
				},
				data: {
					notify: true,
					observer: '_dataChanged'
				},
				location: {
					notify: true
				}
			},
			listeners: {
				'iron-overlay-opened': '_dialogOpened',
				'iron-overlay-closed': '_dialogClosed'
			},
			browsePhoto: function (e) {
				var photoList = this;
				var firebaseKey = this.data[0].__firebaseKey__;

				// Check of the url is already on the user photo node
				var re = /(photo)$/;
				if (!((m = re.exec(this.location)) !== null)) {
					this.location = [this.location, this.data[0].__firebaseKey__, 'photo'].join('/');
				}

				FB.api(
					"/me/albums",
					photoList.storage,
					function (response) {
						if (response && !response.error) {
							for (album in response.data) {
								FB.api(
									response.data[album].id + '/photos?fields=images',
									function (response) {
										for (photo in response.data) {
											if (response.data[photo].images[7]) {
												var image = response.data[photo].images[7].source;
											} else if (response.data[photo].images[6]) {
												var image = response.data[photo].images[6].source;
											} else if (response.data[photo].images[5]) {
												var image = response.data[photo].images[5].source;
											} else if (response.data[photo].images[4]) {
												var image = response.data[photo].images[4].source;
											} else {
												var image = response.data[photo].images[1].source;
											}
											var source = response.data[photo].images[0].source;
											photoList.push('photos', {image: image, source: source});
										}
									}
								);
							}
							photoList.$.dialog.open();
						} else {
							// If the user is not loged in we dispaly message
							document.querySelector('#message').open();
						}
					}
				);
			},
			_handleSelectImage: function (e, detail) {
				console.log(this.data.length);
				if (this.data.length > 0) {
					console.log('-----');
					console.info('Update registred photo');
					this.set('data.'+0+'.photoSourceUrl', this.photoData.photoSourceUrl);
					this.set('data.'+0+'.photoUrl', this.photoData.photoUrl);
					this.set('data.'+0+'.status', this.photoData.status);
				} else {
					console.log('-- Action :');
					console.info('Set registred photo');
					this.push('data', this.photoData);
				}
			},
			_dialogOpened: function (e) {
			},
			_dialogClosed: function (e) {
			},
			_accessArray: function (arr, idx) {
				return arr[idx];
			},
			_photoDataChanged: function (photoData) {
			},
			_dataChanged: function (data) {
			}
		});
	</script>
</dom-module>