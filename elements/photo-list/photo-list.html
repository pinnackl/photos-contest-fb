<dom-module id="photo-list">
	<template>
		<style>
			:host {
				display: block;
			}

			:host paper-card {
			}

			paper-dialog.size-position {
				position: fixed;
				top: 16px;
				right: 16px;
				width: 90%;
				overflow: auto;
				box-sizing: content-box;
			}

			paper-dialog .scroll-section {
				background-color: #F1F1F1;
			}

			.photos {
				width: 240px;
				height: 168px;
				background-color: white;
		        border-top-left-radius: 2px;
		        border-top-right-radius: 2px;
			}
		</style>
		<iron-localstorage id="ls" name="app-storage" value="{{storage}}"></iron-localstorage>
		<paper-button raised on-tap="browsePhoto">Browse Photos</paper-button>
		<paper-dialog id="dialog" class="size-position">
			<h2>Header</h2>
			<paper-dialog-scrollable class="scroll-section">
				<template is="dom-repeat" items={{photos}} as=photo index-as=index>
				<photo-card
					photo="[[photo]]"
					photo-source="[[_accessArray(photoSource, index)]]"
					index="[[index]]"
					data="{{photoData}}">
				</photo-card>
				</template>
			</paper-dialog-scrollable>
			<div class="buttons">
				<paper-button dialog-dismiss>Cancel</paper-button>
				<paper-button dialog-confirm on-tap="_handleSelectImage">Accept</paper-button>
			</div>
		</paper-dialog>
</template>
	<script>
		Polymer({
			is: 'photo-list',
			properties: {
				apiLoaded: {
					observer: '_apiLoaded'
				},
				photos: {
					type: Array,
					value: [],
					notify: true
				},
				photoSource: {
					type: Array,
					value: [],
					notify: true
				},
				storage: {
					type: Object
				},
				photoData: {
					notify: true,
					observer: '_photoDataChanged'
				},
				data: {
					type: Array,
					notify: true,
					observer: '_dataChanged'
				}
			},
			listeners: {
				'iron-overlay-opened': '_dialogOpened',
				'iron-overlay-closed': '_dialogClosed'
			},
			browsePhoto: function (e) {
				var photoList = this;
					// reload the localstorage to get the data stored on login without reloading the page
					photoList.$.ls.reload();
				FB.api(
					"/me/albums",
					photoList.storage,
					function (response) {
						if (response && !response.error) {
							for (album in response.data) {
								FB.api(
									response.data[album].id + '/photos?fields=images',
									photoList.storage,
									function (response) {
										// FIXME : use only once photo object containing {image:"", source: ""}
										for (photo in response.data) {
											if (response.data[photo].images[7]) {
												var image = response.data[photo].images[7].source;
											} else if (response.data[photo].images[6]) {
												var image = response.data[photo].images[6].source;
											} else if (response.data[photo].images[5]) {
												var image = response.data[photo].images[5].source;
											} else if (response.data[photo].images[4]) {
												var image = response.data[photo].images[4].source;
											} else {
												var image = response.data[photo].images[1].source;
											}
											var source = response.data[photo].images[0].source;
											photoList.push('photos', image);
											photoList.push('photoSource', source);
										}
									}
								);
							}
							photoList.$.dialog.open();
						} else {
							// If the user is not loged in we dispaly message
							document.querySelector('#message').open();
						}
					}
				);
			},
			_handleSelectImage: function (e, detail) {
				if (this.data.length > 0) {
					var photoUpdated = false;
					for (var i = 0; i < this.data.length; i++) {
						if (this.data[i].hasOwnProperty('photo')) {
							console.log('-- Action :');
							console.info('Update registred photo');
							this.set('data.'+i+'.photo', this.photoData);
							photoUpdated = true;
						}
					};
					if (i == this.data.length && !photoUpdated) {
						console.log('-- Action :');
						console.info('Set registred photo');
						this.push('data', {photo: this.photoData});
					}
				} else {
					console.log('-- Action :');
					console.info('Set registred photo');
					this.push('data', {photo: this.photoData});
				}
			},
			_dialogOpened: function (e) {
			},
			_dialogClosed: function (e) {
			},
			_accessArray: function (arr, idx) {
				return arr[idx];
			},
			_photoDataChanged: function (photoData) {
			},
			_dataChanged: function (data) {
				console.log(data);
			}
		});
	</script>
</dom-module>