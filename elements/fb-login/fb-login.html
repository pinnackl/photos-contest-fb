<link rel="import" href="../../vendor/polymer/polymer.html">
<link rel="import" href="../../vendor/paper-button/paper-button.html">
<link rel="import" href="../../vendor/iron-icon/iron-icon.html">
<link rel="import" href="../../vendor/firebase-element/firebase-auth.html">

<dom-module id="fb-login">
	<template>
		<style>
			/* FIXME : use custom variable to change properties */
			:host {
				display: inline-block;
				@apply(--fb-login-container-theme);
			}

			:host paper-button {
				/*Shadow properties*/
				color: 				var(--fb-login-color, #FFFFFF);
				background-color: 	var(--fb-login-bg-color, #3B579D);
				font-weight:		var(--fb-login-fw, bold);				
			}

			paper-button {
				/*Mixin to define custom theme*/
				@apply(--fb-login-theme);
			}

			.icon {
			    --iron-icon-height: 32px;
			    --iron-icon-width: 32px;
			}
		</style>
		<iron-localstorage id="ls" name="app-storage" value="{{storage}}"
			on-iron-localstorage-load-empty="_initLocalStorage"></iron-localstorage>
		<firebase-auth id="auth"
					   location="https://blinding-inferno-401.firebaseio.com/"
					   provider="facebook"
					   user="{{user}}"
					   ref="{{ref}}">
		</firebase-auth>
		<paper-button raised
					  on-tap="login">
			<iron-icon class="icon" src="../../img/FB-f-Logo__blue_50.png"></iron-icon>
			Login
		</paper-button>
	</template>
	<script>
		Polymer({
			is: 'fb-login',
			properties: {
				// Determine if the login action is automatically call
				// NOTE : If declared the test is true
				autoLogin: {
					type: Boolean,
					value: false,
					reflectToAttribute: true
				},
				apiLoaded: {
					type: Boolean,
					value: false,
					observer: '_apiObserver'
				},
				// Graph API URL to call to get data
				graphUrl: {
					type: String,
					value: ""
				},
				// Scope param of permission to ask for
				scope: {
					type: String,
					value: "public_profile"
				},
				// Graph API Response Object
				response: {
					type: Object,
					notify: true
				},
				fireUser: {
					notify: true
				},
				ref: {
					notify: true
				},
				// Local storage
				storage: {
					type: Object
				}
			},
			checkLoginStatus: function () {
				var fbLogin = this;
				FB.getLoginStatus(function(response) {
			 		// Check login status on load, and if the user is already logged in
			 		if (response.status == 'connected') {
			 			console.info('Facebook account connected !');
			 			// Populate the param object with the access token
			 			var param =  {user: fbLogin.$.auth.user};
			 			fbLogin._customLoginAction(response.status, param);
			 		} else if (fbLogin.autoLogin) {
				   		// Otherwise, show Login dialog first.
				   		console.info('Facebook account not connected !');
				   		fbLogin.login();
					} else {
						console.info('Facebook account not connected !');
						// Cleanup localstorage access_token
						fbLogin.set('storage', {});
					}
				});
			},
			login: function () {
				var fbLogin = this;

				// Get the connection with the provided scope
				this.$.auth.login({scope: this.scope});
			},
			_apiObserver: function  (n, o) {
				var fbLogin = this;
				if (n) {
					console.info('Fb API is ready !');
					// Check if the user is actualy connected
					this.checkLoginStatus();
					
					// Bind event to the login action
					this.$.auth.addEventListener('login', function (e) {
						console.info('Login into Facebook');
						fbLogin._customLoginAction('connected', e.detail);
					});

					// bind event to the error login action
					this.$.auth.addEventListener('error', function (e) {
						console.info('Login error into Facebook');
						fbLogin._customLoginAction('false', e.detail);
					});
				}
			},
			_customLoginAction: function (response, param) {
				param = (typeof param !== 'undefined')? param : {};

				var fbLogin = this;
				if (response == 'connected') {
					var access_token = param.user.facebook.accessToken;

					fbLogin.set('storage', {'access_token': access_token});

					FB.api(
						'/' + fbLogin.graphUrl,
						{access_token: access_token},
						function(data) {
							fbLogin.response 	= data;
							fbLogin.fireUser	= param.user;
							fbLogin.style.display = 'none';

							// Get the user picture and update the data object
							FB.api(
								"/me/picture",
								function (response) {
									if (response && !response.error) {
										var data = fbLogin.response;
											data['picture'] = response;
										fbLogin.response = {};
										fbLogin.response = data;
									}
								}
							);

							fbLogin.fire('fb-login-success', param);
					});
				} else {
					fbLogin.fire('fb-login-canceled', param);
				}
			},
			_initLocalStorage: function () {
				this.storage = {};
			}
		});
	</script>
</dom-module>