<dom-module id="contest-page">
	<template>
		<style>
			:host {
				display: block;
				margin: 48px 62px;
			}

			paper-material {
				padding: 1em;
			}

			.contest-container {
				margin: 1em 1em;
			}
		</style>
		<paper-material elevation="1">
			<h1>Choose your champion</h1>
			<div class="contest-container">
				<template is="dom-if" if="{{_registeredStatus}}">
					<photo-list id="photoList" fire-user="{{fireUser}}" storage="{{storage}}" data="{{data}}" location="{{location}}"></photo-list>			
				</template>
			</div>
		</paper-material>
	</template>
	<script>
		Polymer({
			is: 'contest-page',
			properties: {
				fireUser: {
					notify: true
				},
				storage: {
					notify: true
				},
				location: {
					notify: true
				},
				data: {
					notify: true
				}
			},
			_userHandle: function (item) {
				// after getting the user check for the contest to be running
				// FIXME : the reload hack to rerender the page
				if (this.fireUser) {
					var re = new RegExp("("+this.fireUser.uid+")$");
					if (((m = re.exec(this.location)) !== null)) {
						this.contestUser = item;
						this._registeredStatus = this._getRegisteredStatus();
						this.location = [this.storage.firebase, 'options', 'contests'].join('/');
						// FIXME: Hack to the dom-repreat element to redraw its content
						item.reload = 'userid';
						return false;
					}
					
					var re = new RegExp("(contests)$");
					if (((m = re.exec(this.location)) !== null)) {
						var contest = item;
						var today = new Date().getTime();
						if (contest.isactive && (today >= contest.start && today <= contest.end)) {
							if (this.contestUser && contest) {
								if (this.contestUser.currentContest.id == contest.__firebaseKey__) {
									this.currentContest = item;
									this.location = [this.storage.firebase, 'users'].join('/');
									item.reload = 'contests';
									return true;
								}
							}
						}
					}

					var re = new RegExp("(users)$");
					if (((m = re.exec(this.location)) !== null)) {
						item.reload = 'users';
						return true;
					}
				}
				return false;
			},
			// Define the ability of the user
			_getRegisteredStatus: function () {
				if (this.contestUser.currentContest.role != 'judge') {
					return true;
				}
				return false;
			}
		});
	</script>
</dom-module>