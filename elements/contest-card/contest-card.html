<link rel="import" href="../../vendor/firebase-element/firebase-collection.html">
<link rel="import" href="../../vendor/firebase-element/firebase-document.html">
<dom-module id="contest-card">
	<template>
		<style>
			:host {
				display: block;
			}

			paper-card {
				--paper-card: {
					width: 70%;
					margin-left: 15%;
				};
				--paper-card-header-text: {
					color: #FFFFFF;
					font-weight: bold;
				};
				--paper-card-background-color: white;
				--paper-card-actions: {

				};
			}

			.contest-info {
				margin-top: 1em;
			}
		</style>
		<iron-localstorage id="ls" name="[[storageLabel]]" value="{{storage}}"></iron-localstorage>
		<firebase-collection
			data="{{fireData}}"
			location="[[fireLocation]]"
			on-firebase-value="_firebaseLoaded">
		</firebase-collection>
		<template is="dom-if" if={{appReady}}>
			<template is="dom-repeat" items="{{data}}" as=contest index-as=index
				filter="_getActiveContest"
				observe="name start end description isactive registration">
				<paper-card heading="[[contest.name]]" image="/img/md-landscape.jpg">
					<div class="card-content">
						<div class="contest-date">
							<span class="contest-start">
								<iron-icon icon="today"></iron-icon>
								[[_toLocalDate(contest.start)]]
							</span>
							<span> - </span>
							<span class="contest-end">
								<iron-icon icon="today"></iron-icon>
								[[_toLocalDate(contest.end)]]
							</span>
						</div>
					</div>
					<div class="card-actions">
						<template is="dom-if" if=!{{fireUser}}>
							<contest-register-button
								text="Register as [[userStatus]]"
								fire-user="{{fireUser}}"
								on-tap="login"
							></contest-register-button>
						</template>
						<paper-icon-button icon="expand-more" title="more info" onclick="_toggle()" style="float:right;">
						</paper-icon-button>
						<iron-collapse id="more-info" class="contest-info">
							[[contest.description]]
						</iron-collapse>
						<script>
							function _toggle() {
								var moreInfo = document.getElementById('more-info');
								var iconButton = Polymer.dom(event).localTarget;
								iconButton.icon = moreInfo.opened ? 'expand-more'
								                                  : 'expand-less';
								moreInfo.toggle();
							}
						</script>
					</div>
				</paper-card>
			</template><!-- 
			<paper-card heading="No contest available" image="" elevation="1" animated-shadow="false" hidden>
				<div class="card-content">Plop</div>
				<div class="card-actions"></div>
			</paper-card> -->
		</template>
	</template>
	<script>
		Polymer({
			is: 'contest-card',
			properties: {
				appReady: {
					observer: '_appReady'
				},
				location: {
					notify: true,
					value: "",
					observer: '_locationChanged'
				},
				fireLocation: {
					type: String,
					observer: '_fireLocationChanged'
				},
				data: {
					notify: true,
					observer: '_dataChanged'
				},
				response: {
					notify: true
				},
				fireUser: {
					notify: true,
					observer: '_userChanged'
				},
				ref: {},
				storageLabel: {},
				storage: {
					observer: '_storageReady'
				}
			},
			ready: function () {
				var _this = this;
				window.addEventListener('fb-login-success', function (e) {
					console.log("Action to perform on login success");
					_this.fireLocation = [_this.storage.firebase, 'users', _this.fireUser.uid].join('/');
					_this.activeRecord = true;
				});
				// var contestCard = this;
				// var updateCallback = function (e) {
				// 	contestCard.location = [contestCard.storage.firebase, 'options', 'contests'].join('/');
				// 	// Remove the listner
				// 	window.removeEventListener('data-updated', updateCallback);
				// };
				// window.addEventListener('data-updated', updateCallback);
			},
			login: function (e) {
				this.fire('login-action');
			},
			_appReady: function (loaded) {
				// this.$.ls.reload();
			},
			_dataChanged: function (data) {
				// if (this.fireUser) {
				// 	var re = new RegExp("/("+this.fireUser.uid+")$/");
				// 	if (!((m = re.exec(this.location)) !== null)) {
				// 		console.log("Get user data");
				// 		if (this.data[0] && this.data[0].currentContest) {
				// 			this.contestId = this.data[0].currentContest.id;
				// 			console.log(this.contestId);
				// 		}
				// 		// this._contestRegister();

				// 	}
				// }
			},
			_firebaseLoaded: function () {
				if (this.fireUser && this.activeRecord) {
					if (this.fireData.length == 0 && this.activeRecord && this.currentContest) {
						console.log("The user does not exist in database");
						console.log(this.fireLocation);
						console.log(this.fireData);
						var user = this.fireUser;

						this.push("fireData", {
							email: user.facebook.email,
							name: user.facebook.displayName,
							photoUrl: user.facebook.profileImageURL,
							id: user.facebook.id,
							currentContest: {
								id: this.currentContest.__firebaseKey__,
								role: this.getContestRegistration()
							}
						});
					} else if (this.activeRecord && this.currentContest) {
						console.log("The user already exist in database");
						console.log(this.fireLocation);
						console.log(this.fireData);

						// var re = new RegExp("("+this.fireUser.uid+")$");
						// if ((m = re.exec(this.fireLocation)) !== null) {
						//     if (m.index === re.lastIndex) {re.lastIndex++;}
						// 	this.fireLocation = [
						// 		this.fireLocation,
						// 		this.fireData[0].__firebaseKey__
						// 	].join('/');
						// }
						// if (this.activeRecord) {
						// 	return;
						// }
						// if ()
						// this.set('fireData.0.email')
						// this.set('fireData.0.name')
						// this.set('fireData.0.photoUrl')
						// this.set('fireData.0.id')
						// this.set('fireData.0.currentContest.0.id', "plop2");
					}
					this.activeRecord = false;
				}
			},
			_locationChanged: function (location) {
			},
			_fireLocationChanged: function (fireLocation) {
			},
			_storageReady: function (storage) {
				// console.log(storage);
			},
			_getActiveContest: function (contest) {
				var re = /contests$/;
				var str = this.location;
				var m;
				if ((m = re.exec(str)) !== null) {
				    if (m[0] == "contests") {
						var today = new Date().getTime();
						if (contest.isactive
							&& (today >= contest.start && today <= contest.end)) {
							this.currentContest = contest;
							this.userStatus = this.getContestRegistration();

							console.log("get the contest info");
							if (!this.contestId)
								this.contestId = this.currentContest.__firebaseKey__;
							return true;
						}
						return false;
				    }
				}
			},
			_userChanged: function (user) {
				if (user && this.currentContest) {
					this.contestId = this.currentContest.__firebaseKey__;
					this.contestRole = this.getContestRegistration();
				} else if (user) {
					// console.warn(this.data);
				}
			},
			getContestRegistration: function () {
				var day = 86400000;
				var today = new Date().getTime();
				var registationPeriod = this.currentContest.start + this.currentContest.registration*day;
				if (today <= registationPeriod) {
					return "participant";
				} else {
					return "judge";
				}

			},
			_toLocalDate: function (date) {
				return new Date(date).toLocaleDateString();
			},
			loginSuccess: function (e, detail) {
				// body...
			},
			registerUser: function (e, detail) {
				// Move the firebase location to the use node
				// update the user contest node (as the user is already registered in firebase)
				// Need to trigger the change event or
				// directly update the user here
				// this.location = [this.storage.firebase, 'users', this.fireUser.uid].join('/');
			},
			_contestRegister: function () {
				// this.set('data.0.contest.id', this.currentContest.__firebaseKey__);
				// this.set('data.0.contest.role', this.getContestRegistration());
			},
			fbNotConnected: function (e, detail) {
				// this.location = [this.storage.firebase, 'options', 'contests'].join('/');
			},
			loginCancel: function (e, detail) {
				// body...
			}
		});
	</script>
</dom-module>