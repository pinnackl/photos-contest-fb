<dom-module id="contest-game">
	<template>
		<style>
			:host {
				display: block;
			}
		</style>
		<firebase-collection
			data="{{dataGame}}"
			location="[[contestLocation]]"
			on-firebase-value="_contestDataFirebaseLoaded">
		</firebase-collection>
		<firebase-collection
			data="{{dataUsers}}"
			location="[[userLocation]]"
			on-firebase-value="_usersDatafirebaseLoaded">
		</firebase-collection>
		<challonge-api id="challongeApi" storage="[[storage]]" on-api-response="_handleApiResponse"></challonge-api>
		<template is="dom-repeat" items=[[players]] as=player>
			<paper-card heading="[[player.name]]" image="[[player.contestPhoto]]" elevation="1">
				<div class="card-content">
				</div>
				<div class="card-actions">
					<contest-like icon="favorite" title="heart" photo-id="[[player.photoId]]" on-register-vote="_registerVote"></contest-like>
				</div>
			</paper-card>
		</template>
		<paper-button>Plop</paper-button>
	</template>
	<script>
		Polymer({
			is: 'contest-game',
			properties: {
				storage: {
					notify: true
				},
				contestLocation: {
					notify: true,
					type: String
				},
				firstUserLocation: {
					notify: true,
					type: String
				},
				firstPhotoDataLocation: {
					notify: true,
					type: String
				},
				routeParam: {
					notify: true,
					observer: "_handleRouteParamChanged"
				},
				currentContest: {},
				matches: {},
				player1Id: {},
				player2Id: {},
				players: {
					notify: true,
					type: Array,
					value: []
				}
			},
			_handleApiResponse: function(e, detail) {
				this.matches = detail.result.match[0];

				this.player1Id = this.matches['player1-id'];
				this.player2Id = this.matches['player2-id'];

				this.userLocation = [this.storage.firebase, 'users'].join('/');
			},
			_registerVote: function(e, detail) {
				var photoId = detail.photoId;
				FB.api(
				    "/" + photoId + "/likes?summary=has_liked,total_count,can_like",
				    function (response) {
				    	if(response.summary.can_like && !response.summary.can_like){
					     	FB.api(
							    "/" + photoId + "/likes",
							    "POST",
							    function (response) {
								
							    }
							);
				    	}
				    }
				);
			},
			_contestDataFirebaseLoaded: function(e, detail) {
				this.getCurrentContest();
				var contestId = this.currentContest.id;
				this.$.challongeApi.mGetAll(contestId);
			},
			_usersDatafirebaseLoaded: function(e, detail) {
				var players = this.dataUsers;
				var tmp = [];
                for(var i = 0; i <= players.length; i++){
                    for (var key in players[i]) {
                        if(key != "__firebaseKey__"){
                            var player = players[i][key];
                            if(player.currentContest.pId == this.player1Id){
                            	var player1 = player;
                            	var nodePhotoPlayer1 = player1.contests.photos;
                            	for(var k in nodePhotoPlayer1) {
                            		var photoPlayer1 = nodePhotoPlayer1[k].photoSourceUrl;
                            		var idPlayer1 = nodePhotoPlayer1[k].id;
                            	}
                            }else if (player.currentContest.pId == this.player2Id) {
                            	var player2 = player;
                            	var nodePhotoPlayer2 = player2.contests.photos;
                            	for(var k in nodePhotoPlayer2) {
                            		var photoPlayer2 = nodePhotoPlayer2[k].photoSourceUrl;
                            		var idPlayer2 = nodePhotoPlayer2[k].id;
                            	}
                            }
                            if(player1 && player2) {
                            	break;
                            }
                        }
                    }
                }
                player1.contestPhoto = photoPlayer1;
                player2.contestPhoto = photoPlayer2;

                player1.photoId = idPlayer1;
                player2.photoId = idPlayer2;

                this.push('players', player1);
                this.push('players', player2);
                console.log(this.players);
			},
			_handleRouteParamChanged: function(routeParam) {
				if(routeParam.customBag){
					this.contestLocation = [this.storage.firebase, 'options', 'contests'].join('/');
				}
			},
			getCurrentContest: function(){
				for(var contest in this.dataGame){
					if(this.dataGame[contest].__firebaseKey__ == this.routeParam.id){
						this.currentContest = this.dataGame[contest];
					}
				}
				return false;
			}
		});
	</script>
</dom-module>